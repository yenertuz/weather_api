<!DOCTYPE html>
<html>
  <head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="A weather API that uses the AccuWeather REST API. Use this website to check the weather for your favorite places.">
	<meta name="author" content="Yener Tuz">
	<link rel="icon" href="https://img.icons8.com/dusk/64/000000/app-symbol.png" type="image/gif" sizes="16x16">
	<title>Weather API assignment - Yener Tuz</title>
  </head>
  <body>
	  <div id='root'></div>
  </body>
  <script>

// personal api key = Ul1GdOP7L4e7JoZjPCEfGD6B3BwWFJKF

// api key from movable = wJzJStEhgnn6wSVdxvK56XpvFE4sYeoC

  function display_state(state) {
    document.getElementById("root").innerHTML = JSON.stringify(state.days);
  }

  function get_index_for_relevant_days(state) {
    state.index = -1;
    state.days_response["DailyForecasts"].forEach(
      (element, index) => {
        let date_string = element["Date"].substring(0, 10);
        if (date_string == state.today_date) {
          state.index = index;
        }
      }
    );
  }

  function fetch_days(state) {
    state.days = state.days_response["DailyForecasts"].slice(state.index, state.index + 3);
  }

  function get_relevant_days(state) {
    let today_date_object = new Date(state.date);
    let today_date_string = today_date_object.toISOString();
    today_date_string = today_date_string.substring(0, 10);
    state.today_date = today_date_string;
    console.log(today_date_string);
    get_index_for_relevant_days(state);
    if (state.index == -1) {
      return ;
    }
    fetch_days(state);
  }

  function get_query_parameters(state) {
    let url_params = new URLSearchParams(window.location.search);
    let zip_code = url_params.get("zip_code");
    let date = url_params.get("date");
    state.zip_code = zip_code;
    state.date = date;
  }

  function fetch_weather_information(state) {
    let url = "http://dataservice.accuweather.com/forecasts/v1/daily/5day/";
    url += state.location_key;
    url += "?apikey=" + state.api_key;
    let ajax_request = new XMLHttpRequest();
    ajax_request.onreadystatechange = function() {
      if (this.readyState != 4 || this.status != 200) {
        return ;
      }
      let response_object = JSON.parse(this.responseText);
      state.days_response = response_object;
      get_relevant_days(state);
      display_state(state);
    }
    ajax_request.open("GET", url, true);
    ajax_request.send();
  }

  function fetch_location_key(state) {
    let url = "http://dataservice.accuweather.com/locations/v1/postalcodes/us/search?";
    url += "q=" + encodeURIComponent(state.zip_code);
    url += "&apikey=" + encodeURIComponent(state.api_key);
    let ajax_request = new XMLHttpRequest();
    ajax_request.onreadystatechange = function() {
      if (this.readyState != 4 || this.status != 200) {
        return ;
      }
      let response_object = JSON.parse(this.responseText);
      state.location_key = response_object[0]["Key"];
      state.city = response_object[0]["EnglishName"];
      state.state = response_object[0]["AdministrativeArea"]["ID"];
      state.key_response = response_object;
      fetch_weather_information(state);
    }
    ajax_request.open("GET", url, true);
    ajax_request.send();
  }

  function main() {
      let state = {};
      window.state = state;
      state.api_key = "Ul1GdOP7L4e7JoZjPCEfGD6B3BwWFJKF";
      get_query_parameters(state);
      fetch_location_key(state);
      return ;
      fetch_weather_information(state);
      render_weather_information(state);
  }
  
  main();
  
  </script> 
</html>
